<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±è¯­å­¦ä¹ å·¥å…· - AIè¯†åˆ«ç‰ˆ</title>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // ===== åç«¯ API åœ°å€ =====
        const API_BASE_URL = 'https://nglish-learning-backend.onrender.com';

        // å›¾æ ‡ç»„ä»¶
        const Upload = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>;
        const Volume2 = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>;
        const BookOpen = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>;
        const X = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
        const ArrowLeft = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>;
        const Lightbulb = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 18h6M10 22h4M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8 6 6 0 0 0 6 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 0 1 8.91 14"></path></svg>;
        const Save = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path></svg>;
        const Trash2 = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path></svg>;
        const CheckCircle = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>;
        const AlertCircle = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>;

        function EnglishLearningTool() {
            const [image, setImage] = useState(null);
            const [extractedText, setExtractedText] = useState('');
            const [translation, setTranslation] = useState('');
            const [words, setWords] = useState([]);
            const [selectedWord, setSelectedWord] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [savedWords, setSavedWords] = useState(() => {
                try {
                    const saved = localStorage.getItem('englishLearningWords');
                    return saved ? JSON.parse(saved) : [];
                } catch { return []; }
            });
            const [showSavedWords, setShowSavedWords] = useState(false);
            const [apiStatus, setApiStatus] = useState('checking');

            useEffect(() => {
                try {
                    localStorage.setItem('englishLearningWords', JSON.stringify(savedWords));
                } catch (error) {
                    console.error('ä¿å­˜å¤±è´¥');
                }
            }, [savedWords]);

            useEffect(() => {
                checkApiStatus();
            }, []);

            const checkApiStatus = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/health`, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    });
                    if (response.ok) {
                        setApiStatus('connected');
                        console.log('âœ… åç«¯è¿æ¥æˆåŠŸ');
                    } else {
                        setApiStatus('error');
                    }
                } catch (error) {
                    console.error('åç«¯è¿æ¥å¤±è´¥:', error);
                    setApiStatus('error');
                }
            };

            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    setImage(event.target.result);
                    setIsLoading(true);
                    
                    try {
                        const formData = new FormData();
                        formData.append('image', file);
                        
                        console.log('å¼€å§‹ OCR è¯†åˆ«...');
                        const ocrResponse = await fetch(`${API_BASE_URL}/api/ocr`, {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (!ocrResponse.ok) {
                            throw new Error(`OCR å¤±è´¥: ${ocrResponse.status}`);
                        }
                        
                        const ocrData = await ocrResponse.json();
                        const text = ocrData.text;
                        setExtractedText(text);
                        console.log('âœ… OCR è¯†åˆ«æˆåŠŸ');

                        console.log('å¼€å§‹ç¿»è¯‘...');
                        const translateResponse = await fetch(`${API_BASE_URL}/api/translate`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ text })
                        });
                        
                        if (translateResponse.ok) {
                            const translateData = await translateResponse.json();
                            setTranslation(translateData.translation);
                            console.log('âœ… ç¿»è¯‘æˆåŠŸ');
                        } else {
                            setTranslation('ç¿»è¯‘æœåŠ¡æš‚æ—¶ä¸å¯ç”¨');
                        }

                        const wordList = text.match(/\b[a-zA-Z]+\b/g) || [];
                        const uniqueWords = [...new Set(wordList.map(w => w.toLowerCase()))];
                        setWords(uniqueWords.filter(w => w.length > 2));

                    } catch (error) {
                        console.error('å¤„ç†å¤±è´¥:', error);
                        alert('è¯†åˆ«å¤±è´¥: ' + error.message + '\n\nå¯èƒ½æ˜¯åç«¯æœåŠ¡æ­£åœ¨å†·å¯åŠ¨,è¯·ç­‰å¾…30ç§’åé‡è¯•');
                        setExtractedText('');
                        setTranslation('');
                        setWords([]);
                    }
                    
                    setIsLoading(false);
                };
                reader.readAsDataURL(file);
            };

            const speakText = (text) => {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'en-US';
                    utterance.rate = 0.9;
                    window.speechSynthesis.speak(utterance);
                }
            };

            const openWordDetail = async (word) => {
                setIsLoading(true);
                try {
                    console.log('æŸ¥è¯¢å•è¯:', word);
                    const response = await fetch(`${API_BASE_URL}/api/dictionary/${word}`);
                    if (!response.ok) throw new Error('è¯å…¸æŸ¥è¯¢å¤±è´¥');
                    
                    const data = await response.json();
                    setSelectedWord(data);
                    console.log('âœ… å•è¯æŸ¥è¯¢æˆåŠŸ');
                } catch (error) {
                    console.error('æŸ¥è¯¢å¤±è´¥:', error);
                    alert('å•è¯æŸ¥è¯¢å¤±è´¥: ' + error.message);
                }
                setIsLoading(false);
            };

            const saveWord = (word) => {
                if (!savedWords.find(w => w.word === word.word)) {
                    setSavedWords([...savedWords, { ...word, savedAt: new Date().toISOString() }]);
                    alert('âœ… å·²ä¿å­˜åˆ°ç”Ÿè¯æœ¬!');
                } else {
                    alert('â„¹ï¸ è¯¥å•è¯å·²åœ¨ç”Ÿè¯æœ¬ä¸­');
                }
            };

            const removeWord = (wordToRemove) => {
                if (confirm(`ç¡®å®šåˆ é™¤"${wordToRemove}"?`)) {
                    setSavedWords(savedWords.filter(w => w.word !== wordToRemove));
                }
            };

            if (showSavedWords) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 sm:p-8">
                        <div className="max-w-4xl mx-auto">
                            <div className="bg-white rounded-2xl shadow-xl p-6">
                                <div className="flex items-center justify-between mb-6">
                                    <button onClick={() => setShowSavedWords(false)} className="flex items-center gap-2 text-gray-600 hover:text-gray-900">
                                        <ArrowLeft /> è¿”å›
                                    </button>
                                    <h2 className="text-2xl font-bold text-gray-800">ç”Ÿè¯æœ¬ ({savedWords.length})</h2>
                                    <div className="w-20"></div>
                                </div>
                                {savedWords.length === 0 ? (
                                    <div className="text-center py-12 text-gray-400">
                                        <div className="flex justify-center mb-4"><BookOpen /></div>
                                        <p>è¿˜æ²¡æœ‰ä¿å­˜çš„å•è¯</p>
                                    </div>
                                ) : (
                                    <div className="grid gap-4">
                                        {savedWords.map((word, idx) => (
                                            <div key={idx} className="border rounded-xl p-4 hover:shadow-md transition">
                                                <div className="flex items-start justify-between">
                                                    <div className="flex-1">
                                                        <div className="flex items-center gap-3 mb-2">
                                                            <h3 className="text-xl font-bold text-blue-600">{word.word}</h3>
                                                            <button onClick={() => speakText(word.word)} className="p-1 hover:bg-blue-50 rounded-full">
                                                                <Volume2 />
                                                            </button>
                                                            <span className="text-sm text-gray-500">{word.phonetic}</span>
                                                        </div>
                                                        <p className="text-gray-700">{word.translation}</p>
                                                    </div>
                                                    <button onClick={() => removeWord(word.word)} className="p-2 text-red-500 hover:bg-red-50 rounded-full">
                                                        <Trash2 />
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            if (selectedWord) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 sm:p-8">
                        <div className="max-w-2xl mx-auto">
                            <div className="bg-white rounded-2xl shadow-xl p-6 sm:p-8">
                                <div className="flex items-center justify-between mb-6">
                                    <button onClick={() => setSelectedWord(null)} className="flex items-center gap-2 text-gray-600">
                                        <ArrowLeft /> è¿”å›
                                    </button>
                                    <button onClick={() => saveWord(selectedWord)} className="flex items-center gap-2 bg-green-500 text-white px-4 py-2 rounded-full hover:bg-green-600 text-sm">
                                        <Save /> ä¿å­˜
                                    </button>
                                </div>
                                <div className="text-center mb-8">
                                    <h1 className="text-4xl font-bold text-blue-600 mb-3">{selectedWord.word}</h1>
                                    <div className="flex items-center justify-center gap-3 mb-2">
                                        <button onClick={() => speakText(selectedWord.word)} className="bg-blue-500 text-white p-3 rounded-full hover:bg-blue-600">
                                            <Volume2 />
                                        </button>
                                        <span className="text-xl text-gray-600">{selectedWord.phonetic}</span>
                                    </div>
                                    <span className="inline-block bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-sm">{selectedWord.level}</span>
                                </div>
                                <div className="mb-6">
                                    <h3 className="text-lg font-semibold mb-2 flex items-center gap-2">
                                        <BookOpen /> ä¸­æ–‡é‡Šä¹‰
                                    </h3>
                                    <p className="text-xl bg-blue-50 p-4 rounded-lg">{selectedWord.translation}</p>
                                </div>
                                <div className="mb-6">
                                    <h3 className="text-lg font-semibold mb-2">è‹±æ–‡å®šä¹‰</h3>
                                    <p className="bg-gray-50 p-4 rounded-lg">{selectedWord.definition}</p>
                                </div>
                                {selectedWord.examples && selectedWord.examples.length > 0 && (
                                    <div className="mb-6">
                                        <h3 className="text-lg font-semibold mb-2">ä¾‹å¥</h3>
                                        {selectedWord.examples.map((ex, i) => (
                                            <div key={i} className="bg-green-50 p-3 rounded-lg mb-2 flex gap-2">
                                                <button onClick={() => speakText(ex)} className="p-1"><Volume2 /></button>
                                                <p className="flex-1">{ex}</p>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                <div className="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-4">
                                    <h3 className="font-semibold mb-2 flex items-center gap-2">
                                        <Lightbulb /> è®°å¿†æŠ€å·§
                                    </h3>
                                    <p>{selectedWord.memory}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 sm:p-8">
                    <div className="max-w-4xl mx-auto">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl sm:text-4xl font-bold text-gray-800 mb-2">ğŸ“š è‹±è¯­å­¦ä¹ å·¥å…·</h1>
                            <p className="text-gray-600">ä¸Šä¼ è‹±æ–‡æˆªå›¾ï¼ŒAIè‡ªåŠ¨è¯†åˆ«ç¿»è¯‘å­¦ä¹ </p>
                        </div>

                        {apiStatus === 'checking' && (
                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 flex items-center gap-3">
                                <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
                                <p className="text-blue-700">æ­£åœ¨è¿æ¥åç«¯æœåŠ¡å™¨...</p>
                            </div>
                        )}
                        {apiStatus === 'error' && (
                            <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                                <div className="flex items-start gap-3">
                                    <AlertCircle />
                                    <div>
                                        <p className="text-red-700 font-semibold">âš ï¸ æ— æ³•è¿æ¥åç«¯æœåŠ¡å™¨</p>
                                        <p className="text-sm text-red-600 mt-2">Render å…è´¹ç‰ˆåœ¨æ— æ´»åŠ¨æ—¶ä¼šä¼‘çœ ,é¦–æ¬¡è®¿é—®éœ€è¦ç­‰å¾…30-60ç§’å¯åŠ¨</p>
                                        <button onClick={checkApiStatus} className="mt-3 text-sm bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                                            é‡æ–°è¿æ¥
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                        {apiStatus === 'connected' && (
                            <div className="bg-green-50 border border-green-200 rounded-lg p-3 mb-4 flex items-center justify-center gap-2">
                                <CheckCircle />
                                <p className="text-green-700 font-medium">âœ… åç«¯è¿æ¥æˆåŠŸ! æ‰€æœ‰åŠŸèƒ½å¯ç”¨</p>
                            </div>
                        )}

                        <div className="flex justify-end mb-4">
                            <button onClick={() => setShowSavedWords(true)} className="flex items-center gap-2 bg-purple-500 text-white px-4 py-2 rounded-full hover:bg-purple-600">
                                <BookOpen /> ç”Ÿè¯æœ¬ ({savedWords.length})
                            </button>
                        </div>

                        {!image && (
                            <div className="bg-white rounded-2xl shadow-xl p-8">
                                <label className={`flex flex-col items-center justify-center border-2 border-dashed rounded-xl p-12 transition ${apiStatus === 'connected' ? 'border-blue-300 cursor-pointer hover:border-blue-500 hover:bg-blue-50' : 'border-gray-300 opacity-50 cursor-not-allowed'}`}>
                                    <Upload />
                                    <span className="text-lg text-gray-700 mb-2 mt-4">
                                        {apiStatus === 'connected' ? 'ç‚¹å‡»ä¸Šä¼ è‹±æ–‡æˆªå›¾' : 'ç­‰å¾…åç«¯è¿æ¥...'}
                                    </span>
                                    <span className="text-sm text-gray-500">æ”¯æŒ JPG, PNG æ ¼å¼</span>
                                    <input type="file" accept="image/*" onChange={handleImageUpload} disabled={apiStatus !== 'connected'} className="hidden" />
                                </label>
                                <div className="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <p className="text-sm text-blue-700">ğŸ’¡ <strong>æç¤º:</strong> ä½¿ç”¨æ¸…æ™°ã€å…‰çº¿è‰¯å¥½çš„å›¾ç‰‡å¯ä»¥æé«˜è¯†åˆ«å‡†ç¡®ç‡</p>
                                </div>
                            </div>
                        )}

                        {image && (
                            <div className="bg-white rounded-2xl shadow-xl p-6">
                                <div className="flex justify-between mb-4">
                                    <h2 className="text-xl font-bold">AIè¯†åˆ«ç»“æœ</h2>
                                    <button onClick={() => { setImage(null); setExtractedText(''); setWords([]); setTranslation(''); }} className="text-red-500 hover:bg-red-50 p-2 rounded-full">
                                        <X />
                                    </button>
                                </div>
                                <img src={image} alt="ä¸Šä¼ çš„å›¾" className="w-full rounded-lg mb-4 max-h-64 object-contain bg-gray-50" />
                                {isLoading ? (
                                    <div className="text-center py-8">
                                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                                        <p className="text-gray-600">AIè¯†åˆ«å¤„ç†ä¸­...</p>
                                        <p className="text-sm text-gray-500 mt-2">é¦–æ¬¡ä½¿ç”¨å¯èƒ½éœ€è¦30-60ç§’,è¯·è€å¿ƒç­‰å¾…</p>
                                    </div>
                                ) : (
                                    <>
                                        {extractedText && (
                                            <>
                                                <div className="mb-4">
                                                    <div className="flex justify-between mb-2">
                                                        <h3 className="font-semibold text-gray-800">è¯†åˆ«æ–‡æœ¬</h3>
                                                        <button onClick={() => speakText(extractedText)} className="flex items-center gap-1 text-blue-600 px-3 py-1 rounded-full text-sm hover:bg-blue-50">
                                                            <Volume2 /> æœ—è¯»
                                                        </button>
                                                    </div>
                                                    <p className="bg-gray-50 p-4 rounded-lg leading-relaxed">{extractedText}</p>
                                                </div>
                                                {translation && (
                                                    <div className="mb-6">
                                                        <h3 className="font-semibold text-gray-800 mb-2">ä¸­æ–‡ç¿»è¯‘</h3>
                                                        <p className="bg-blue-50 p-4 rounded-lg">{translation}</p>
                                                    </div>
                                                )}
                                                <div>
                                                    <h3 className="font-semibold text-gray-800 mb-3">è¯†åˆ«åˆ° {words.length} ä¸ªå•è¯ (ç‚¹å‡»å­¦ä¹ )</h3>
                                                    <div className="flex flex-wrap gap-2">
                                                        {words.map((word, i) => (
                                                            <button key={i} onClick={() => openWordDetail(word)} className="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-4 py-2 rounded-full hover:shadow-lg transform hover:scale-105 transition">
                                                                {word}
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>
                                            </>
                                        )}
                                    </>
                                )}
                            </div>
                        )}

                        <div className="bg-white rounded-2xl shadow-xl p-6 mt-6">
                            <h3 className="font-semibold text-gray-800 mb-3">ğŸ’¡ ä½¿ç”¨è¯´æ˜</h3>
                            <ul className="space-y-2 text-sm text-gray-600">
                                <li>âœ… <strong>å·²å®ç°åŠŸèƒ½:</strong> OCRè¯†åˆ«ã€æ™ºèƒ½ç¿»è¯‘ã€è¯å…¸æŸ¥è¯¢ã€ç”Ÿè¯æœ¬å­˜å‚¨</li>
                                <li>ğŸ“¸ ä¸Šä¼ æ¸…æ™°çš„è‹±æ–‡å›¾ç‰‡(æ–°é—»ã€ä¹¦ç±ã€äº§å“åŒ…è£…ç­‰)</li>
                                <li>ğŸ¤– AIè‡ªåŠ¨è¯†åˆ«å¹¶ç¿»è¯‘æ–‡æœ¬</li>
                                <li>ğŸ“š ç‚¹å‡»å•è¯æŸ¥çœ‹è¯¦ç»†é‡Šä¹‰å’Œä¾‹å¥</li>
                                <li>ğŸ’¾ ä¿å­˜é‡è¦å•è¯åˆ°ç”Ÿè¯æœ¬æ°¸ä¹…å­˜å‚¨</li>
                                <li>âš¡ é¦–æ¬¡ä½¿ç”¨éœ€è¦ç­‰å¾…åç«¯å¯åŠ¨(çº¦30-60ç§’)</li>
                            </ul>
                            <div className="mt-4 bg-green-50 border border-green-200 rounded-lg p-3 text-sm">
                                <p className="text-green-700">ğŸš€ <strong>æŠ€æœ¯æ ˆ:</strong> Tesseract.js OCR + ç™¾åº¦ç¿»è¯‘API + Free Dictionary API + Renderäº‘éƒ¨ç½²</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<EnglishLearningTool />, document.getElementById('root'));
    </script>
</body>
</html>
